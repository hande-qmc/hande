sudo: false
dist: trusty

language: python

os:
  - linux
  - osx

python:
  - "2.7"
  - "3.5"

addons:
  apt:
    packages:
      - cmake3
      - cmake3-data
      - gfortran
      - libblas-dev
      - liblapack-dev
      - libopenmpi-dev
      - openmpi-bin
      - uuid-dev

env:
  global:
    - DEPS=$HOME/Deps
    - LUA_ROOT=$DEPS/lua
    - HDF5_ROOT=$DEPS/hdf5
    - ScaLAPACK_ROOT=$DEPS/scalapack
    # Paths for BLAS, LAPACK, and UUID from packages
    - LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:/usr/lib/libblas:/usr/lib/lapack${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}
    - LD_LIBRARY_PATH=$LUA_ROOT/lib:$HDF5_ROOT/lib:$ScaLAPACK_ROOT/lib:$DEPS/trlan/lib${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}

before_install:
  # Dependencies are downloaded in $HOME/Downloads and installed in $HOME/Deps
  - mkdir -p $HOME/Downloads $DEPS

cache:
  pip: true
  directories:
    - $HOME/Deps/lua
    - $HOME/Deps/hdf5
    - $HOME/Deps/scalapack
    - $HOME/Deps/trlan

install:
  - ./.ci/install_deps.sh
  - pip install -r requirements.txt

before_script:
  - >
    if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      tools/mkconfig.py travis.linux
    elif [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      tools/mkconfig.py travis.macosx
    fi

script:
  - make
  # Only run a short subset of the tests
  - cd test_suite
  - $DEPS/testcode/bin/testcode.py -c vquick -v

notifications:
  email:
    - hande-dev@imperial.ac.uk
